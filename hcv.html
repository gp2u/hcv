<!DOCTYPE html>
<html>
<head>
<title>HCV Decision Support</title>
<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/themes/smoothness/jquery-ui.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.blockUI/2.66.0-2013.10.09/jquery.blockUI.js"></script>
 
<style>

p,td,input,div,select { font-family: sans-serif; font-size:1em;}
td { padding: 2px 0;}
label { float:right; padding-right:3px;}

.narrow { width:40px; font-size:0.8em;}
.notes { font-size:0.9em }
.error { color:red;}
.title { font-weight: 700; padding-top:0.5em;}
.grading { font-size:0.9em;}
button:focus {outline:0;}

@media print {
    #print { display:none;}
    #dataInput { display:none;}
}

</style>
</head>

<body>

<script>
var version = '1.3';

var ratings = {
    classILevelA   : 'Class I, Level A',
    classILevelB   : 'Class I, Level B',
    classIILevelA  : 'Class II, Level A',
    classIILevelB  : 'Class II, Level B',
    classIIaLevelA : 'Class IIa, Level A',
    classIIaLevelB : 'Class IIa, Level B',
    classIIbLevelA : 'Class IIb, Level A',
    classIIbLevelB : 'Class IIb, Level B',
    A1: 'A1 - High, Strong',
    A2: 'A2 - High, Weak',
    B1: 'B1 - Moderate, Strong',
    B2: 'B2 - Moderate, Weak',
    C1: 'C1 - Low, Strong',
    C2: 'C2 - Low, Weak'
}

var drugs = {
    sof: {
        generic: 'Sofosbuvir',
        dose: ['400mg'],
        brand: [
        'Solvadi',
        'Hopetavir (Incepta)',
        'Sofovir (Hetero)',
        'Hepcinat (Natco)',
        'Soforal (Beacon)',
        'Hepcvir (Cipla)',
        'Sofovir-C (Beximco)',
        'Hepcee (Julphar)',
        'MyHep (Mylan)'
        ],
        route: 'PO',
        freq: 'daily',
        notes: []
   },
    sof_led: {
        generic: 'Sofosbuvir/Ledipasvir',
        dose: ['400mg/90mg'],
        brand: [
        'Harvoni',
        'Twinvir (Incepta)',
        'Hepcvir-L (Cipla)',
        'Ledifos (Hetero)',
        'Hepcinat LP (Natco)',
        'Lesovir-C (Beximco)',
        'Combicee (Julphar)',
        'MyHep LVIR (Mylan)'
        ],
        route: 'PO',
        freq: 'daily',
        notes: ['In the ION-3 trial, patients without cirrhosis and a baseline HCV RNA levels less than 6 million IU/mL had similar relapse rates when treated with 8 weeks versus 12 weeks. Decreasing the length of the regimen to 8 weeks should be done with caution.'
        ]
    },
    dac: {
        generic: 'Daclatasvir',
        dose: ['60mg','30mg'],
        brand: [
        'Daklinza',
        'Virodacla (Incepta)',
        'Daclahep (Hetero)',
        'Daclavir (Beacon)',
        'Daclacee (Julphar)'
        ],
        route: 'PO',
        freq: 'daily',
        notes: ['The dose of daclatasvir may need to be increased or decreased when used concomitantly with cytochrome P450 3A/4 inducers and inhibitors, respectively.'
        ]
    },
    riba: {
        generic: 'Ribavirin',
        dose: ['200mg','400mg','600mg'],
        brand: [
        'Ibavyr',
        'Celbarin (Incepta)',
        'Ribacee (Julphar)'
        ],
        route: 'PO',
        freq: 'daily divided into 2 doses',
        notes: []
    },
    viek: {
        generic: 'Paritaprevir/Ritonavir/Ombitasvir',
        dose: [ '75mg/50mg/12.5mg' ],
        brand: [ 'Viekira Pak' ],
        route: 'PO',
        freq: 'two tablets once daily',
        notes: ['Contraindicated in patients with Child-Turcotte-Pugh class B or C hepatic impairment.']
    },
    viekx: {
        generic: 'Dasabuvir',
        dose: [ '250mg' ],
        brand: [ 'Viekira Pak' ],
        route: 'PO',
        freq: 'twice daily',
        notes: []
    },
    peg: {
        generic: 'PegInterferon-&alpha;2a',
        dose: [ '180&mu;g'],
        brand: [ 'Pegasys' ],
        route: 'SC',
        freq: 'weekly',
        note: []
    },
    peg2b: {
        generic: 'PegInterferon-&alpha;2b',
        dose: [ '1.5&mu;g/kg'],
        brand: [ 'PegIntron' ],
        route: 'SC',
        freq: 'weekly',
        note: []
    },
    sim: {
        generic: 'Simeprevir',
        dose: [ '150mg' ],
        brand: [ 'Olysio' ],
        route: 'PO',
        freq: 'daily',
        notes: []
    }
};

var svrx = {
    gt1: {
        sof_led: {
            default: 97,
            rating: {
                aasld: ratings.classILevelA,
                easl: undefined
            },
            gt1a: {
                default: 97, // ION-1 98% (142/145) ION-3 96% 96% (165/172) Aggregate 96.8% (307/317)
                rating: {
                    aasld: ratings.classILevelA,
                    easl: undefined                                   
                }
            },
            gt1b: {
                default: 99, // ION-1 100% (67/67) ION-3 98% (43/44) Aggregate 99.1% (110/111)
                rating: {
                    aasld: ratings.classILevelA,
                    easl: undefined                                   
                }
            },
            f4: { 
                default: 97,
                rating: {
                    aasld: ratings.classILevelB,
                    easl: undefined                                   
                },
                w12: 97,      // ION-1 97% (32/33)
                w12riba: 100, // ION-1 100% (33/33)
                w24: 97,      // ION-1 97% (31/32)
                w24riba: 100  // ION-1 100% (36/36)
            },
            fail: {
                default: 94,
                rating: {
                    aasld: ratings.classILevelB,
                    easl: undefined
                },
                w12: 94,     // ION-3 94% (102/109) 
                w12riba: 96, // ION-3 96% (107/111) 
                w24: 99,     // ION-3 99% (108/109) 
                w24riba: 99  // ION-3 99% (110/111)
            }

        },
        sof_dac: {
            default: 97,
            rating: {
                aasld: ratings.classILevelB,
                easl: undefined
            },
            gt1a: {
                default: 95,
                rating: {
                    aasld: ratings.classILevelB,
                    easl: undefined
                }
            },
            gt1b: {
                default: 95,
                rating: {
                    aasld: ratings.classILevelB,
                    easl: undefined
                }
            },
            f4: {},
            fail: {}
        },
        sof_sim: {
            default: 95,
            rating: {
                aasld: ratings.classILevelA,
                easl: undefined
            },
            gt1a: {
                default: 95,
                rating: {
                    aasld: ratings.classILevelA,
                    easl: undefined
                }
            },
            gt1b: {
                default: 95,
                rating: {
                    aasld: ratings.classILevelA,
                    easl: undefined
                }
            },
            f4: {},
            fail: {}
        },
        viek: {
            default: 95,
            rating: {
                aasld: ratings.classILevelA,
                easl: undefined
            },
            gt1a: {
                default: 95,
                rating: {
                    aasld: ratings.classILevelA,
                    easl: undefined
                }
            },
            gt1b: {
                default: 95,
                rating: {
                    aasld: ratings.classILevelA,
                    easl: undefined
                }
            },
            f4: {},
            fail: {}
        }
    },
    gt2: {

    },
    gt3: {

    },
    gt4: {

    },
    gt5: {

    },
    gt6: {

    }
}

function supportDecision () {

    $("#demographics").html('');
    $("#rx").html('');
    var h = {};
    h.genotype  = $("#genotype option:selected").text();
    h.fibrosis  = $("#fibrosis option:selected").text();
    h.harvoniCI = $("input[name=harvoniCI]:checked").val();
    h.guidelines= $("input[name=guidelines]:checked").val();
    h.past      = $("#past option:selected").val();
    h.pastTxt    = $("#past option:selected").text();
    h.riba      = $("#riba:checked").length == 1 ? true : false;
    h.platelets = parseInt($("#platelets").val());
    h.weight    = $("input[name=weight]:checked").val();
    h.eGFR      = $("#eGFR").val();
    h.eGFR      = h.eGFR.replace('>','');
    h.eGFR      = parseInt(h.eGFR);
    h.locale    = h.guidelines == 'AASLD' ? 'en-US' : h.guidelines == 'EASL' ? 'en-GB' : 'en-AU';

    var error = '';
    var errorFocus = ''
    if (h.genotype  == '' ) { 
        error += 'Please select Genotype<br>'; 
        if (errorFocus == '') errorFocus = '#genotype' 
    }
    if (h.fibrosis  == '' ) { 
        error += 'Please select Fibrosis<br>'; 
        if (errorFocus == '') errorFocus = '#fibrosis' 
    }
    if (h.pastTxt   == '' ) { 
        error += 'Please select Past Treament<br>'; 
        if (errorFocus == '') errorFocus = '#past' 
    }
    if (h.harvoniCI === undefined ) { 
        error += 'Please select Harvoni CI<br>'; 
        if (errorFocus == '') errorFocus = '#harvoniCI' 
    }
    if (h.riba) {
        if (isNaN(h.platelets)) { 
            error += 'Please input Platelets<br>'; 
            if (errorFocus == '') errorFocus = '#platelets' 
        }
        if (typeof h.weight === "undefined") { 
            error += 'Please select Weight<br>'; 
            if (errorFocus == '') errorFocus = '#weight' 
        }
        if (isNaN(h.eGFR)) { 
            error += 'Please input eGFR<br>'; 
            if (errorFocus == '') errorFocus = '#eGFR' 
        }
    }
    if (error != '') {
        errorDialog(error,errorFocus)
        setTimeout(function(){$("#demographics").html(errorText(error))},1000);      
        return;
    }

    h.fail =  (h.past == 'naive' || h.past == 'PEG' ) ? false : true;
    h.harvoniCI = (h.harvoniCI == 'yes') ? true : false;

    // visual feedback to user
    blockMessage('Calculating...',500);
    $("#calculate").val('Recalculate');
    setTimeout(function(){doCalculation(h)},500);
}

function doCalculation (h) {

    renderDemographics(h);
    renderRx(h);
}

function renderDemographics(h) {

    var demographics = 'Guidelines:     ' + h.guidelines + '\n' +
                       'Genotype:       ' + h.genotype   + '\n' +
                       'Fibrosis:       ' + h.fibrosis   + '\n' + 
                       'Past Treatment: ' + h.pastTxt    + '\n' +
                       'Past Failure:   ' + h.fail       + '\n' +
                       'Harvoni CI:     ' + h.harvoniCI  + '\n' +
                       'Ribavirin:      ' + h.riba       + '\n';
    if ( h.riba ) {
        demographics += 
                       'Platelets:      ' + h.platelets      + '\n' +
                       'Weight:         ' + h.weight + ' kg' + '\n' +
                       'eGFR:           ' + $("#eGFR").val() + '\n';
    }
    var d = new Date();
    demographics = '<p><b>HCV Decision Support v' + version + ' ' + d.toLocaleString(h.locale) + '</b></p><pre>' + demographics + '</pre>';
    $("#demographics").html(demographics);
} 

function renderRx(h) {

    h.rx = [];
    getRxOptions(h); //alert(JSON.stringify(h));
    var html = '';
    // display by descending SVR
    h.rx.sort(function(a, b){return b.svr-a.svr});

    for ( var m in h.rx ) {
        var svrOdds = Math.round(100/(100-h.rx[m].svr)) - 1;
        var days = h.rx[m].duration == 24 ? '84 days + 1 repeat' : '84 days + no repeats';
        var medication = '';
        for ( var d in h.rx[m].medication ) {
            var drug = h.rx[m].medication[d];
            if ( parseInt(d) > 0 ) medication += drug.optional ? ' &plusmn; ' : ' + ';
            //alert(JSON.stringify(drug));
            medication += drug.generic + ' (' + drug.brand[0] + ') ' + drug.dose[0] + ' ' + drug.route +', ' + drug.freq;
            var drugSort = drug.brand.slice();
            drugSort.sort();
            h.rx[m].notes.push(drug.generic + ' brand names: ' + drugSort.join(', '));
        }
        html += '<hr>' +
                '<b>Medications:</b> '   + medication + '<br>' +
                '<b>Duration:</b> '     + h.rx[m].duration + ' weeks (' + days + ')<br>' +
                '<b>Expected SVR:</b> ' + h.rx[m].svr + '% (Odds of SVR are '  + svrOdds + ':1)<br>';

        if (typeof h.rx[m].rating !== 'undefined') html += '<b>Rating:</b> <a href="javascript:evidence()">' + h.rx[m].rating + '</a><br>';

        h.rx[m].notes.unshift('Check for interactions using <a href="http://www.hep-druginteractions.org/Interactions.aspx" target="_new">http://www.hep-druginteractions.org/Interactions.aspx</a>');
        html += '<br><div class="notes"><b>Notes:</b><ol>';
        for (var i in h.rx[m].notes) {
            html += '<li>' + h.rx[m].notes[i] + '</li>';
        }
        html += '</ol></div>';
    }
    html += '<div id="print"><hr><input type="button" value="Print" onclick="window.print()"></div>'
    $("#rx").html(html);
}

function getRxOptions(h) {

    if (h.guidelines == 'AUS') {
        if ( h.genotype.match(/1/) ) rxGT1AUS(h);
        if ( h.genotype.match(/2/) ) rxGT2AUS(h);   
        if ( h.genotype.match(/3/) ) rxGT3AUS(h);
        if ( h.genotype.match(/4/) ) rxGT4AUS(h);
        if ( h.genotype.match(/5/) ) rxGT5AUS(h);
        if ( h.genotype.match(/6/) ) rxGT6AUS(h);       
    }
    else if (h.guidelines == 'EASL') {
        blockMessage('EASL not yet implemented',2000);
        if ( h.genotype.match(/1/) ) rxGT1EASL(h);
        if ( h.genotype.match(/2/) ) rxGT2EASL(h);   
        if ( h.genotype.match(/3/) ) rxGT3EASL(h);
        if ( h.genotype.match(/4/) ) rxGT4EASL(h);
        if ( h.genotype.match(/5/) ) rxGT5EASL(h);
        if ( h.genotype.match(/6/) ) rxGT6EASL(h); 
    }
    else if (h.guidelines == 'AASLD') {
        if ( h.genotype.match(/1/) ) rxGT1AASLD(h);
        if ( h.genotype.match(/2/) ) rxGT2AASLD(h);   
        if ( h.genotype.match(/3/) ) rxGT3AASLD(h);
        if ( h.genotype.match(/4/) ) rxGT4AASLD(h);
        if ( h.genotype.match(/5/) ) rxGT5AASLD(h);
        if ( h.genotype.match(/6/) ) rxGT6AASLD(h); 
    }
    else if (h.guidelines == 'FIXHEPC') {
        if ( h.genotype.match(/1/) ) rxGT1(h);
        if ( h.genotype.match(/2/) ) rxGT2(h);   
        if ( h.genotype.match(/3/) ) rxGT3(h);
        if ( h.genotype.match(/4/) ) rxGT4(h);
        if ( h.genotype.match(/5/) ) rxGT5(h);
        if ( h.genotype.match(/6/) ) rxGT6(h);       
    }
    else {
        alert('OMG, the flux capacitor has imploded!');
    }

}

/* AUS Treatment Protocols */

function rxGT1AUS (h) {

    // sof dac
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.dac ], 
        duration: 12,
        svr: svrx.gt1.sof_dac.default, 
        notes: drugs.dac.notes.slice()
    });
    if ( h.past == 'PROTEASE' ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = 90;
        h.rx[0].notes.push('24 weeks recommended for patients who have failed a protease inhibitor');
    }
    if ( h.fibrosis.match(/F4/) ) {
        h.rx[0].svr = 90;
        if ( h.past != 'PROTEASE' ) {
            h.rx[0].notes.push(errorText('Consider adding Ribavirin or extending treatment to 24 weeks'));
        }
    }
    // viekira pak
    h.rx.unshift({
        medication: [ drugs.viek, drugs.viekx ],
        duration: 12,
        svr: 97,
        notes: []
    })
    if ( ! h.genotype.match(/1b/)) {
        addRiba(h,h.rx[0],false);
        h.rx[0].svr = 95;

    }
    // harvoni
    if (hasHarvoniCI(h)) return;
    h.rx.unshift({
        medication: [ drugs.sof_led ],
        duration: 12,
        svr: 96,
        notes: []
    })
    if ( h.genotype.match(/1b/)) h.rx[0].svr = 98;
    if ( h.fibrosis.match(/F4/) && h.fail ) {
        h.rx[0].duration = 24;
        h.rx[0].svr      = 94;
        h.rx[0].notes.push('12 weeks + Ribavirin may be considered');
    }
    if ( ! h.fail && ! h.fibrosis.match(/F4/) ) {
        h.rx[0].notes.push('8 weeks may be considered if HCV RNA < 6 x 10^6 IU/ml');
    }
}

function rxGT2AUS (h) {

    // sof riba
    h.rx.unshift({
        medication: [ drugs.sof ],
        duration: 12,
        svr: 96,
        notes: []
    });
    addRiba(h,h.rx[0]);
    if ( h.fibrosis.match(/F4/) ) {
        h.rx[0].svr      = 94;
        h.rx[0].notes.push(errorText('SVR rates may be increased by extending duration to 16-24 weeks'));
    }
}

function rxGT3AUS (h) {

    // sof dac
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.dac ], 
        duration: 12,
        svr: 96, 
        notes: ['Daclatasvir levels are elevated by CYP3A4 inhibitors'] 
    });
    if ( h.fibrosis.match(/F4/) ) {
        h.rx[0].duration = 24;
        h.rx[0].svr      = 94;
        h.rx.unshift({ 
            medication:[ drugs.sof, drugs.dac ], 
            duration: 16,
            svr: 94, 
            notes: ['Daclatasvir levels are elevated by CYP3A4 inhibitors'] 
        });
        addRiba(h,h.rx[0]);
    }
    // sof riba
    h.rx.unshift({
        medication: [ drugs.sof ],
        duration: 24,
        svr: 93,
        notes: []
    });
    addRiba(h,h.rx[0]);
    if ( h.fibrosis.match(/F4/) ) {
        h.rx[0].svr      = 67;
    }
    // sof peg riba
    h.rx.unshift({
        medication: [ drugs.sof, drugs.peg ],
        duration: 12,
        svr: 85,
        notes: []
    });
    addRiba(h,h.rx[0]);    
}

function rxGT4AUS (h) {

    // sof peg riba
    h.rx.unshift({
        medication: [ drugs.sof, drugs.peg ],
        duration: 12,
        svr: 90,
        notes: []
    });
    addRiba(h,h.rx[0]); 
    // sim peg riba
    h.rx.unshift({
        medication: [ drugs.sim, drugs.peg ],
        duration: 48,
        svr: 85,
        notes: [ 'Duration 24-48 weeks']
    });
    addRiba(h,h.rx[0]);
}

function rxGT5AUS (h) {

    // sof peg riba
    h.rx.unshift({
        medication: [ drugs.sof, drugs.peg ],
        duration: 12,
        svr: 90,
        notes: []
    });
    addRiba(h,h.rx[0]); 
}

function rxGT6AUS (h) {

    // sof peg riba
    h.rx.unshift({
        medication: [ drugs.sof, drugs.peg ],
        duration: 12,
        svr: 90,
        notes: []
    });
    addRiba(h,h.rx[0]);    
}

/* EASL stubs */
function rxGT1EASL (h) {}
function rxGT2EASL (h) {}
function rxGT3EASL (h) {}
function rxGT4EASL (h) {}
function rxGT5EASL (h) {}
function rxGT6EASL (h) {}

/* AASLD stubs */
function rxGT1AASLD (h) {
    if ( h.fail ) {
        if ( h.past == 'PEGRIBA' ) {
            rxGT1AASLDpegriba(h);
        }
        else if ( h.past == 'SOFRIBA') {
            rxGT1AASLDsofriba(h);
        }
        else if ( h.past == 'PROTEASE' ) {
            rxGT1AASLDprotease(h);
        }
        else if ( h.past == 'SOFNS5A' ) {
            rxGT1AASLDsofNS5A(h);
        }
        else {
            alert('Error - unhandled failure case: ' + h.past )
        }
    }
    else {
        if ( h.genotype.match(/1b/) ) {
            rxGT1AASLDnaive1b(h);
        }
        else {
            rxGT1AASLDnaive1a(h);       
        }
    }
}

function rxGT1AASLDnaive1a (h) {

    // sofosbuvir daclatasvir
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.dac ], 
        duration: 12,
        svr: svrx.gt1.sof_dac.gt1a.default, 
        rating: svrx.gt1.sof_dac.gt1a.rating,
        notes: drugs.dac.notes.slice()
    });
    if ( h.fibrosis.match(/F4/) ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = svrx.gt1.sof_dac.gt1a.f4.default;
        h.rx[0].rating = svrx.gt1.sof_dac.gt1a.f4.rating;
        addRiba(h,h.rx[0],true);

    }
    // harvoni
    if ( ! hasHarvoniCI(h)) {
        h.rx.unshift({
            medication: [ drugs.sof_led ],
            duration: 12,
            svr: svrx.gt1.sof_led.gt1a.default,
            rating: svrx.gt1.sof_led.gt1a.rating,           
            notes: drugs.sof_led.notes.slice()
        });
    }
    // viekira pak
    h.rx.unshift({
        medication: [ drugs.viek, drugs.viekx ],
        duration: 12,
        svr: svrx.gt1.viek.gt1a.default,
        rating: svrx.gt1.viek.gt1a.rating,
        notes: drugs.viek.notes.slice()
    });
    addRiba(h,h.rx[0],false);    
    if ( h.fibrosis.match(/F4/) ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = svrx.gt1.viek.gt1a.f4.default;
        h.rx[0].rating = svrx.gt1.viek.gt1a.f4.rating;
    }
    // sofosbuvir simeprevir
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.sim ], 
        duration: 12,
        svr: svrx.gt1.sof_sim.gt1a.default,
        rating: svrx.gt1.sof_sim.gt1a.rating, 
        notes: drugs.sim.notes.slice()
    });
    if ( h.fibrosis.match(/F4/) ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = svrx.gt1.sof_sim.gt1a.f4.default;
        h.rx[0].rating = svrx.gt1.sof_sim.gt1a.f4.rating;    
        addRiba(h,h.rx[0],true);
    }

}

function rxGT1AASLDnaive1b (h) {

    // sofosbuvir daclatasvir
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.dac ], 
        duration: 12,
        svr: svrx.gt1.sof_dac.gt1b.default, 
        rating: svrx.gt1.sof_dac.gt1b.rating,
        notes: drugs.dac.notes.slice()
    });
    if ( h.fibrosis.match(/F4/) ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = svrx.gt1.sof_dac.gt1b.f4.default;
        h.rx[0].rating = svrx.gt1.sof_dac.gt1b.f4.rating;
        addRiba(h,h.rx[0],true);

    }
    // harvoni
    if ( ! hasHarvoniCI(h)) {
        h.rx.unshift({
            medication: [ drugs.sof_led ],
            duration: 12,
            svr: svrx.gt1.sof_led.gt1b.default,
            rating: svrx.gt1.sof_led.gt1b.rating,           
            notes: drugs.sof_led.notes.slice()
        });
    }
    // viekira pak
    h.rx.unshift({
        medication: [ drugs.viek, drugs.viekx ],
        duration: 12,
        svr: svrx.gt1.viek.gt1b.default,
        rating: svrx.gt1.viek.gt1b.rating,
        notes: drugs.viek.notes.slice()
    });

    // sofosbuvir simeprevir
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.sim ], 
        duration: 12,
        svr: svrx.gt1.sof_sim.gt1b.default,
        rating: svrx.gt1.sof_sim.gt1b.rating, 
        notes: drugs.sim.notes.slice()
    });
    if ( h.fibrosis.match(/F4/) ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = svrx.gt1.sof_sim.gt1b.f4.default;
        h.rx[0].rating = svrx.gt1.sof_sim.gt1b.f4.rating;    
        addRiba(h,h.rx[0],true);
    }

}

function rxGT1AASLDpegriba (h) {
    alert(arguments.callee.name)
}

function rxGT1AASLDsofriba (h) {
    alert(arguments.callee.name)
}

function rxGT1AASLDprotease (h) {
    alert(arguments.callee.name)
}

function rxGT1AASLDsofNS5A (h) {
    alert(arguments.callee.name)
}

function rxGT2AASLD (h) {}
function rxGT3AASLD (h) {}
function rxGT4AASLD (h) {}
function rxGT5AASLD (h) {}
function rxGT6AASLD (h) {}

/* SVR and Rx References 

http://www.hepatitisc.uw.edu/go/treatment-infection/treatment-genotype-1/core-concept/all
https://www.gilead.com/~/media/Files/pdfs/medicines/liver-disease/harvoni/harvoni_pi.pdf
http://www.easl.eu/medias/cpg/HEPC-2015/Summary.pdf

*/

function rxGT1 (h) {
   // sof dac
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.dac ], 
        duration: 12,
        svr: 96, 
        notes: ['Daclatasvir levels are elevated by CYP3A4 inhibitors'] 
    });
    if ( h.fibrosis.match(/F4/) || h.past == 'PROTEASE' ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = 90;
        if ( h.past == 'PROTEASE' ) h.rx[0].notes.push('24 weeks recommended for patients who have failed a protease inhibitor');
    }
    // harvoni
    if (hasHarvoniCI(h)) return;
    h.rx.unshift({
        medication: [ drugs.sof_led ],
        duration: 12,
        svr: 96,
        notes: []
    })
    if ( h.genotype.match(/1b/)) h.rx[0].svr = 98;
    if ( h.fibrosis.match(/F4/) ) {
        h.rx[0].duration = 24;
        h.rx[0].svr      = 94;
    }
}

/* http://www.hepatitisc.uw.edu/go/treatment-infection/treatment-genotype-2/core-concept/all */

function rxGT2 (h) {
   // sof dac
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.dac ], 
        duration: 12,
        svr: 96, 
        notes: ['Daclatasvir levels are elevated by CYP3A4 inhibitors'] 
    });
    if ( h.fibrosis.match(/F4/) || h.past == 'PROTEASE' ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = 90;
        if ( h.past == 'PROTEASE' ) h.rx[0].notes.push('24 weeks recommended for patients who have failed a protease inhibitor');
    }
}

/* http://www.hepatitisc.uw.edu/go/treatment-infection/treatment-genotype-3/core-concept/all */

function rxGT3 (h) {
   // sof dac
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.dac ], 
        duration: 12,
        svr: 96, 
        notes: ['Daclatasvir levels are elevated by CYP3A4 inhibitors'] 
    });
    if ( h.fibrosis.match(/F4/) || h.past == 'PROTEASE' ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = 90;
        if ( h.past == 'PROTEASE' ) h.rx[0].notes.push('24 weeks recommended for patients who have failed a protease inhibitor');
    }
}

/* http://www.hepatitisc.uw.edu/go/treatment-infection/treatment-genotype-4/core-concept/all */

function rxGT4 (h) {
   // sof dac
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.dac ], 
        duration: 12,
        svr: 93, 
        notes: ['Daclatasvir levels are elevated by CYP3A4 inhibitors'] 
    });
    if ( h.fibrosis.match(/F4/) || h.past == 'PROTEASE' ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = 90;
        if ( h.past == 'PROTEASE' ) h.rx[0].notes.push('24 weeks recommended for patients who have failed a protease inhibitor');
    }
    // harvoni
    if (hasHarvoniCI(h)) return;
    h.rx.unshift({
        medication: [ drugs.sof_led ],
        duration: 12,
        svr: 93,
        notes: []
    })
}

/* http://www.hepatitisc.uw.edu/go/treatment-infection/treatment-genotype-5-or-6/core-concept/all */

function rxGT5 (h) {
    // sof dac
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.dac ], 
        duration: 12,
        svr: 93, 
        notes: ['Daclatasvir levels are elevated by CYP3A4 inhibitors'] 
    });
    if ( h.fibrosis.match(/F4/) || h.past == 'PROTEASE' ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = 90;
        if ( h.past == 'PROTEASE' ) h.rx[0].notes.push('24 weeks recommended for patients who have failed a protease inhibitor');
    }
    // harvoni
    if (hasHarvoniCI(h)) return;
    h.rx.unshift({
        medication: [ drugs.sof_led ],
        duration: 12,
        svr: 93,
        notes: []
    })
}

/* http://www.hepatitisc.uw.edu/go/treatment-infection/treatment-genotype-5-or-6/core-concept/all */

function rxGT6 (h) {
   // sof dac
    h.rx.unshift({ 
        medication:[ drugs.sof, drugs.dac ], 
        duration: 12,
        svr: 96, 
        notes: ['Daclatasvir levels are elevated by CYP3A4 inhibitors'] 
    });
    if ( h.fibrosis.match(/F4/) || h.past == 'PROTEASE' ) {
        h.rx[0].duration = 24;
        h.rx[0].svr = 90;
        if ( h.past == 'PROTEASE' ) h.rx[0].notes.push('24 weeks recommended for patients who have failed a protease inhibitor');
    }
    // harvoni
    if (hasHarvoniCI(h)) return;
    h.rx.unshift({
        medication: [ drugs.sof_led ],
        duration: 12,
        svr: 96,
        notes: []
    })
}

function hasHarvoniCI (h) {
    if (h.harvoniCI) {
        var msg = errorText('Sofosbuvir/Ledipasvir not being recommended due to Harvoni CI(s)');
        blockMessage(msg);
        h.rx[0].notes.push(msg);
        return true;
    }
    return false;
}

function addRiba(h,rx,optional) {
    if (! h.riba) {
        var msg = 'Sorry, we can\'t accurately add Ribavirin without Ribavirin details. Please add them and recalculate.';
        $("#riba").prop('checked', true);
        $("#ribavirin").show();
        errorDialog(msg, "#platelets");
        rx.notes.push(errorText(msg));
    }
    var ribaDose = h.riba ? calcRibaDose(h,rx) : 1000;
    // need to clone drugs.riba so we can have multiple riba notes associated with various Rx options
    var riba = $.extend(true,{},drugs.riba);
    riba.optional = optional ? true : false;
    riba.dose = [ribaDose + 'mg'];
    rx.medication.push(riba);
    if (optional) {
        rx.notes.push(errorText('Ribavirin is optional'));
    }
    else {
        rx.notes.push(errorText('Ribavirin is mandatory'));        
    }
    rx.notes.push('Ribavirin uses requires frequent monitoring for pancytopaenia');
    if ( h.platelets < 50 ) rx.notes.push(errorText('Low platelets are a relative contraindication to Ribavirin'));
    rx.notes.push('Ribavirin (200mg Capsules): ' + calcRibaCaps(ribaDose));
    rx.notes.push('Ribavirin (Ibavyr 400mg &amp; 600mg Tablets): ' + calcRibaTabs(ribaDose));
}

function setRibaWeight() {

    var guidelines= $("input[name=guidelines]:checked").val();
    if ( guidelines == 'AUS' || guidelines == 'AASLD') {
        $("#weightFull").hide();
        $("#weight75").show();
        $("#sfw").show();
        $("#sfwHR").hide();
    }
    else {
        $("#weightFull").show();
        $("#weight75").hide();
    }
}

function showFullWeightOptions() {
    $('#weightFull').show()
    $('#sfw').hide();
    $('#sfwHR').show();
}

function calcRibaDose (h,rx) {

    if ( ! h.riba ) return 0;
    var dose = 0;
    if ( h.weight == '>105' ) {
        dose = 1400;
    }
    else if ( h.weight == '81-105' || h.weight == '>75' ) {
        dose = 1200;
    }
    else if ( h.weight == '66-80' || h.weight == '<75' ) {
        dose = 1000;  
    }
    else if ( h.weight == '<66' ) {
        dose = 800;
    }
    else {
        alert('Error for weight: ' + h.weight );
    }
    if ( h.eGFR < 60 ) {
        rx.notes.push(errorText('Specialist advice highly recommended about Ribavirin dose'));
        dose =  h.eGFR > 30 ? dose/2 : dose/3;
    }
  
    return 100 * Math.round(dose/100);
}

// standard Riba formulation is 200 mg capsules
function calcRibaCaps (dose) {

    if ( dose >=1400 ) {
        return '3 in the morning 4 at night';
    }
    if ( dose >=1200 ) {
        return '3 in the morning 3 at night';
    }
    if ( dose >=1000 ) {
        return '2 in the morning 3 at night';
    }
    if ( dose >=800 ) {
        return '2 in the morning 2 at night';
    }
    if ( dose >=600 ) {
        return '1 in the morning 2 at night';
    }
    if ( dose >=400 ) {
        return '1 in the morning 1 at night';
    }
    if ( dose >=300 ) {
        return 'Alternating doses, 1 daily alternating with 2 daily every other day';
    }
    if ( dose >=200 ) {
        return '1 daily';
    }
    return errorText('No Riba dose!');
}

// Ibavyr tablets come in 400mg and 600mg scored
function calcRibaTabs (dose) {

    if ( dose >=1400 ) {
        return '2 x 400mg in the morning 600mg at night';
    }
    if ( dose >=1200 ) {
        return '600 mg morning and night';
    }
    if ( dose >=1000 ) {
        return '600mg in the morning 400mg at night';
    }
    if ( dose >=800 ) {
        return '400mg morning and night';
    }
    if ( dose >=600 ) {
        return '&frac12; 600mg morning and night';
    }
    if ( dose >=400 ) {
        return '&frac12; 400mg morning and night';
    }
    if ( dose >=300 ) {
        return '&frac12; 600mg daily';
    }
    if ( dose >=200 ) {
        return '&frac12; 400mg daily';
    }
    return errorText('No Riba dose!');
}

function setFibrosisFromKPa () {

    var kpa = parseFloat($("#kpa").val());

    if (isNaN(kpa)) {
        return;
    }

    if ( kpa >= 14.5 ) {
        $("#fibrosis").val('F4');
    }
    else if ( kpa >= 12.5 ) {
        $("#fibrosis").val('F3-F4');
    }
    else if ( kpa >= 9.5 ) {
        $("#fibrosis").val('F3');
    }
    else if ( kpa >= 8.5 ) {
        $("#fibrosis").val('F2');
    }
    else if ( kpa >= 7 ) {
        $("#fibrosis").val('F1-F2');
    }
    else {
        $("#fibrosis").val('F0-F1'); 
    }
 
}

function setFibrosisHepascore () {

    var hepascore = parseFloat($("#hepascore").val());

    if (isNaN(hepascore)) {
        return;
    }

    if ( hepascore >= 0.7 ) {
        $("#fibrosis").val('F4');
    }
    else if ( hepascore >= 0.5 ) {
        $("#fibrosis").val('F3-F4');
    }
    else if ( hepascore >= 0.3 ) {
        $("#fibrosis").val('F2');
    }
    else if ( hepascore >= 0.15 ) {
        $("#fibrosis").val('F1');
    }
    else {
        $("#fibrosis").val('F0-F1');
    }
}

function toggleRiba () {
    $("#riba:checked").length == 1 ? $("#ribavirin").slideDown() : $("#ribavirin").hide(400);
}

function blockMessage(message,timeout) {

    if (timeout === undefined) timeout = 3000;
    $.blockUI({ 
        message: message, 
        css: {
            border: 'none',
            top: '100px',
            padding: '10px 20px',
            backgroundColor: 'rgba(255, 255, 255, 1)',
            '-webkit-border-radius': '10px',
            '-moz-border-radius': '10px',
            'border-radius': '10px',
            color: '#000'
        },
        timeout: timeout,
    });
}

function errorText(text) {
    return '<span class="error">' + text + '</span>';
}

function errorDialog(text,e) {
    $('#error').html(errorText(text)).dialog({
        title: "Error",
        modal: true,
        open: function(event, ui) { $('.ui-widget-overlay').bind('click', function(){ $("#error").dialog('close'); $(e).select().focus() } ) }
    })
};

function evidence() {
    if ($("input[name=guidelines]:checked").val() == 'AASLD') {
        $("#gradingAASLD").dialog({
            title: 'AASLD Grading System Used For Guidelines',
            width: "80%",
            modal: true,
            open: function(event, ui) { $('.ui-widget-overlay').bind('click', function(){ $("#gradingAASLD").dialog('close') } ) }
        });
    }
    else {
        $("#gradingEASL").dialog({
            title: 'EASL Grading System Used For Guidelines',
            width: "80%",
            modal: true,
            open: function(event, ui) { $('.ui-widget-overlay').bind('click', function(){ $("#gradingEASL ").dialog('close') } ) }
        });
    }
}

</script>

<div id="dataInput">
<div style="float:left;padding:4px 40px 0 0"><b>HCV Decision Support Tool</b></div>
<div style="float:left;" id="google_translate_element"></div>
<div style="clear:both"></div>
<hr>
<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en', layout: google.translate.TranslateElement.InlineLayout.SIMPLE}, 'google_translate_element');
}
</script>
<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
  <table>
    <tr>
      <td>
        <label>Genotype</label>
      </td>
      <td>
        <select id="genotype">
          <option></option>
          <option>1</option>
          <option>1a</option>
          <option>1b</option>
          <option>2</option>
          <option>2a</option>
          <option>2b</option>
          <option>3</option>
          <option>3a</option>
          <option>3b</option>
          <option>4</option>
          <option>5</option>
          <option>6</option>
          <option>Unknown</option>
        </select>
      </td>
    </tr>
    <tr>
      <td>
        <label>Fibrosis</label>
      </td>
      <td>
        <select id="fibrosis">
          <option></option>
          <option>F0</option>
          <option>F0-F1</option>
          <option>F1</option>
          <option>F1-F2</option>
          <option>F2</option>
          <option>F2-F3</option>
          <option>F3</option>
          <option>F3-F4</option>
          <option>F4</option>
        </select>
        kPa
        <input type="text" class="narrow" id="kpa" onblur="setFibrosisFromKPa()"> Hepascore
        <input type="text" class="narrow" id="hepascore" onblur="setFibrosisHepascore()">
      </td>
    </tr>
    <tr>
      <td>
        <label>Past Treatment</label>
      </td>
      <td>
        <select id="past">
          <option></option>
          <option value="naive">Naive</option>
          <option value="PEG">Failed Interferon</option>
          <option value="PEGRIBA">Failed Interferon + Riba</option>
          <option value="PROTEASE">Failed Protease + Interferon + Riba</option>
          <option value="PROTEASE">Failed Simeprevir + Sofosbuvir (no prior NS5A treatment)</option>
          <option value="SOFRIBA">Failed Sofosbuvir + Ribavirin +/- Interferon</option>
          <option value="SOFNS5A">Failed Sofosbuvir + NS5A (Led or Dac) or Viekira Pak</option>
        </select>
      </td>
    </tr>
    <tr>
      <td>
        <label>Harvoni CI<label>
      </td>
      <td>
        <input type="radio" name="harvoniCI" value="no"> No
        <input type="radio" name="harvoniCI" value="yes"> Yes (Amiodarone, Anticonvulsants, Antacids/PPIs/H2 blockers, St John's Wort)</td>
    </tr>
    <tr>
      <td>
        <label>Guidelines<label>
      </td>
      <td>
        <input type="radio" name="guidelines" value="AUS" checked="checked" onChange="setRibaWeight()"> AUS
        <input type="radio" name="guidelines" value="EASL" onChange="setRibaWeight()"> EASL
        <input type="radio" name="guidelines" value="AASLD" onChange="setRibaWeight()"> AASLD
        <input type="radio" name="guidelines" value="FIXHEPC" onChange="setRibaWeight()"> PEG/Riba Free
      </td>
    </tr>
    <tr>
      <td>
        <label>Ribavirin<label>
      </td>
      <td>
        <input type="checkbox" id="riba" onChange="toggleRiba()"> (Check this box to include ribavirin options)</td>
    </tr>
    <tr>
      <td> </td>
      <td>
        <fieldset id="ribavirin" style="display:none">
          <legend>Ribavirin Only</legend>
          <table>
            <tr>
              <td>
                <label>Platelets<label>
              </td>
              <td>
                <input type="text" class="narrow" id="platelets"> * If <50 Ribavirin presents significant risks
              </td>
            </tr>
            <tr>
              <td>
                <label>Weight<label>
              </td>
              <td>
                <div id="weightFull" style="display:none">
                <input type="radio" name="weight" value="&lt;66"> &lt; 66kg
                <input type="radio" name="weight" value="66-80"> 66-80kg
                <input type="radio" name="weight" value="81-105"> 81-105kg
                <input type="radio" name="weight" value="&gt;105"> &gt; 105kg
                </div>
                <div id="weight75" style="clear:left">
                <hr id="sfwHR" style="display:none">
                <input type="radio" name="weight" value="&lt;75"> &lt; 75kg
                <input type="radio" name="weight" value="&gt;75"> &gt; 75kg
                <a id="sfw" href="javascript:showFullWeightOptions()">Show full weight options</a>
                </div>
              </td>
            </tr>
            <tr>
              <td>
                <label>eGFR<label>
              </td>
              <td>
                <input type="text" class="narrow" id="eGFR"> * Dose adjustment with CRF will be calculated
              </td>
            </tr>
          </table>
        </fieldset>
      </td>
    </tr>
    <tr>
      <td> </td>
      <td>
        <input type="button" value="Calculate" id="calculate" onclick="supportDecision()">
      </td>
    </tr>
  </table>
  <hr>
</div>

<div id="demographics">
<p>Please make your selections and press the calculate button</p>
<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.</p>
</div>

<div id="rx"></div>

<div id="error"></div>

<div id="gradingAASLD" class="grading" style="display:none;">

<div class="title">Class I</div>
<div class="description">Conditions for which there is evidence and/or general agreement that a given diagnostic evaluation, procedure, or treatment is beneficial, useful, and effective</div>

<div class="title">Class II</div>
<div class="description">Conditions for which there is conflicting evidence and/or a divergence of opinion about the usefulness and efficacy of a diagnostic evaluation, procedure, or treatment</div>

<div class="title">Class IIa</div>
<div class="description">Weight of evidence and/or opinion is in favor of usefulness and efficacy</div>

<div class="title">Class IIb</div>
<div class="description">Usefulness and efficacy are less well established by evidence and/or opinion</div>

<div class="title">Class III</div>
<div class="description">Conditions for which there is evidence and/or general agreement that a diagnostic evaluation, procedure, or treatment is not useful and effective or if it in some cases may be harmful</div>

<hr>

<div class="title">Evidence Quality</div>

<div class="title">Level A</div>
<div class="description">Data derived from multiple randomized clinical trials or meta-analyses</div>

<div class="title">Level B</div>
<div class="description">Data derived from a single randomized trial, or nonrandomized studies</div>

<div class="title">Level C</div>
<div class="description">Consensus opinion of experts, case studies, or standard of care</div>

</div>

<div id="gradingEASL" class="grading" style="display:none;">

<div class="title">Evidence Quality</div>

<div class="title">A - High</div>
<div class="description">Further research is very unlikely to change our confidence in the estimate of effect</div>

<div class="title">B - Moderate</div>
<div class="description">Further research is likely to have an important impact on our confidence in the estimate of effect and may
change the estimate</div>

<div class="title">C - Low</div>
<div class="description">Further research is very likely to have an important impact on our confidence in the estimate of effect and
is likely to change the estimate. Any change of estimate is uncertain</div>

<hr>

<div class="title">Recommendation</div>

<div class="title">1 - Strong</div> 
<div class="description">Factors influencing the strength of the recommendation included the quality of the evidence, presumed
patient-important outcomes, and cost</div>

<div class="title">2 - Weak</div> 
<div class="description">Variability in preferences and values, or more uncertainty. Recommendation is made with less certainty,
higher cost or resource consumption</div>

</div>

</body>

</html>
